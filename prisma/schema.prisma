generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER & AUTH
// ============================================

model User {
  id              String    @id @default(cuid())
  email           String?   @unique
  emailVerified   DateTime?
  passwordHash    String?
  name            String?
  username        String?   @unique
  image           String?
  bio             String?
  walletAddress   String?   @unique
  githubId        String?   @unique
  githubUsername  String?
  
  // Verification & Trust
  isVerified      Boolean   @default(false)
  verifiedAt      DateTime?
  kycStatus       KycStatus @default(NONE)
  
  // Stats
  totalSales      Int       @default(0)
  totalPurchases  Int       @default(0)
  totalVolume     Float     @default(0)
  rating          Float     @default(0)
  ratingCount     Int       @default(0)
  
  // Referral System
  referralCode       String?   @unique  // Unique code like "alex123" or auto-generated
  referralCodeCustomized Boolean @default(false)  // Can only customize once
  referredBy         String?   // User ID of who referred them
  referralEarnings   Float     @default(0)  // Total earnings from referrals
  
  // Profile Fields (optional)
  displayName     String?
  websiteUrl      String?
  discordHandle   String?
  discordVerified Boolean   @default(false)
  githubVerified  Boolean   @default(false)
  walletVerified  Boolean   @default(false)

  // Timestamps
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  lastActiveAt    DateTime  @default(now())

  // Relations
  listings        Listing[]        @relation("SellerListings")
  bids            Bid[]
  purchases       Transaction[]    @relation("BuyerTransactions")
  sales           Transaction[]    @relation("SellerTransactions")
  reviewsGiven    Review[]         @relation("ReviewAuthor")
  reviewsReceived Review[]         @relation("ReviewSubject")
  watchlist       Watchlist[]
  notifications   Notification[]
  disputes        Dispute[]        @relation("DisputeInitiator")
  disputeResponses Dispute[]       @relation("DisputeRespondent")
  accounts        Account[]
  sessions        Session[]
  offers          Offer[]
  pendingWithdrawals PendingWithdrawal[]

  // Referral Relations
  referralsGiven  Referral[]       @relation("Referrer")
  referralReceived Referral?       @relation("ReferredUser")

  // Messaging Relations
  conversationsAsParticipant1 Conversation[] @relation("ConversationParticipant1")
  conversationsAsParticipant2 Conversation[] @relation("ConversationParticipant2")
  messagesSent    Message[]        @relation("MessageSender")

  @@index([walletAddress])
  @@index([email])
  @@index([githubUsername])
  @@index([referralCode])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ============================================
// LISTINGS & AUCTIONS
// ============================================

model Listing {
  id                String        @id @default(cuid())
  slug              String        @unique
  
  // Basic Info
  title             String
  tagline           String?
  description       String        @db.Text
  category          Category
  blockchain        Blockchain?   // Optional: for on-chain/crypto projects
  tags              String[]
  
  // Tech Stack
  techStack         String[]
  frameworks        String[]
  languages         String[]
  
  // Assets Included
  githubRepo        String?
  githubRepoId      String?
  hasDomain         Boolean       @default(false)
  domain            String?
  hasDatabase       Boolean       @default(false)
  databaseType      String?
  hasHosting        Boolean       @default(false)
  hostingProvider   String?
  hasSocialAccounts Boolean       @default(false)
  socialAccounts    Json?
  hasApiKeys        Boolean       @default(false)
  hasDesignFiles    Boolean       @default(false)
  hasDocumentation  Boolean       @default(false)
  additionalAssets  String?       @db.Text
  
  // Media
  thumbnailUrl      String?
  screenshotUrls    String[]
  demoUrl           String?
  videoUrl          String?

  // Required Buyer Information (seller specifies what they need from buyers)
  // JSON structure: { github?: { required: true, description: "..." }, domain?: {...}, ... }
  requiredBuyerInfo Json?
  buyerInfoLocked   Boolean   @default(false)  // Locked once first purchase is made
  
  // Metrics (if deployed)
  monthlyUsers      Int?
  monthlyRevenue    Float?
  githubStars       Int?
  
  // Auction Settings
  listingType       ListingType   @default(AUCTION)
  startingPrice     Float
  reservePrice      Float?
  buyNowPrice       Float?
  buyNowEnabled     Boolean       @default(false)
  currency          Currency      @default(APP)
  
  // Timing
  startTime         DateTime      @default(now())
  endTime           DateTime
  
  // Status
  status            ListingStatus @default(DRAFT)
  featured          Boolean       @default(false)
  featuredUntil     DateTime?
  
  // On-chain
  onChainId         String?       @unique
  escrowAddress     String?
  nftMint           String?
  
  // Relations
  sellerId          String
  seller            User          @relation("SellerListings", fields: [sellerId], references: [id])
  bids              Bid[]
  offers            Offer[]
  pendingWithdrawals PendingWithdrawal[]
  transaction       Transaction?
  watchlist         Watchlist[]
  
  // Timestamps
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  publishedAt       DateTime?

  @@index([sellerId])
  @@index([status])
  @@index([category])
  @@index([endTime])
  @@index([featured])
}

model Bid {
  id            String    @id @default(cuid())
  amount        Float
  currency      Currency  @default(SOL)
  maxBid        Float?    // For auto-bidding
  
  // On-chain
  onChainTx     String?
  
  // Status
  isWinning     Boolean   @default(false)
  isOutbid      Boolean   @default(false)
  
  // Relations
  listingId     String
  listing       Listing   @relation(fields: [listingId], references: [id])
  bidderId      String
  bidder        User      @relation(fields: [bidderId], references: [id])
  
  // Timestamps
  createdAt     DateTime  @default(now())

  @@index([listingId])
  @@index([bidderId])
  @@index([isWinning])
}

// ============================================
// OFFERS & WITHDRAWALS
// ============================================

model Offer {
  id            String      @id @default(cuid())
  amount        Float
  deadline      DateTime
  currency      Currency    @default(SOL)

  // Status
  status        OfferStatus @default(ACTIVE)

  // On-chain
  onChainId     String?     @unique
  escrowAddress String?

  // Relations
  listingId     String
  listing       Listing     @relation(fields: [listingId], references: [id])
  buyerId       String
  buyer         User        @relation(fields: [buyerId], references: [id])

  // Timestamps
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  acceptedAt    DateTime?
  cancelledAt   DateTime?
  expiredAt     DateTime?

  @@index([listingId])
  @@index([buyerId])
  @@index([status])
  @@index([deadline])
}

model PendingWithdrawal {
  id            String   @id @default(cuid())
  amount        Float
  currency      Currency @default(SOL)
  claimed       Boolean  @default(false)

  // On-chain
  onChainId     String?  @unique

  // Relations
  userId        String
  user          User     @relation(fields: [userId], references: [id])
  listingId     String
  listing       Listing  @relation(fields: [listingId], references: [id])

  // Timestamps
  createdAt     DateTime @default(now())
  claimedAt     DateTime?

  @@index([userId])
  @@index([listingId])
  @@index([claimed])
}

// ============================================
// UPLOADS (Asset Transfer)
// ============================================

model Upload {
  id            String     @id @default(cuid())

  // Upload Type
  type          UploadType

  // File/URL Info
  url           String?    // GitHub URL, file URL, etc.
  fileKey       String?    // S3/storage key
  fileName      String?
  fileSize      Int?       // in bytes

  // Metadata (credentials, social accounts, etc.)
  metadata      Json?

  // Verification
  verified      Boolean    @default(false)
  verifiedAt    DateTime?

  // Relations
  transactionId String
  transaction   Transaction @relation(fields: [transactionId], references: [id])

  // Timestamps
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  @@index([transactionId])
  @@index([type])
  @@index([verified])
}

// ============================================
// TRANSACTIONS & ESCROW
// ============================================

model Transaction {
  id                  String            @id @default(cuid())
  
  // Amount
  salePrice           Float
  platformFee         Float
  sellerProceeds      Float
  currency            Currency          @default(SOL)
  
  // Payment
  paymentMethod       PaymentMethod
  stripePaymentId     String?
  onChainTx           String?
  escrowAddress       String?
  
  // Status
  status              TransactionStatus @default(PENDING)

  // Transfer Checklist
  transferChecklist   Json?

  // Buyer Information Collection (48-hour deadline after purchase)
  buyerProvidedInfo     Json?             // Info submitted by buyer
  buyerInfoDeadline     DateTime?         // 48 hours from purchase
  buyerInfoStatus       BuyerInfoStatus   @default(PENDING)
  buyerInfoSubmittedAt  DateTime?

  // Transfer Methods per asset (tracks native vs fallback)
  // JSON structure: { github: { method: "native"|"fallback", ... }, domain: {...} }
  transferMethods       Json?
  fallbackTransferUsed  Boolean           @default(false)

  // Upload Verification
  sellerConfirmedTransfer Boolean        @default(false)
  uploadsVerified         Boolean        @default(false)
  verificationHash        String?
  verifiedAt              DateTime?

  // NFT
  ownershipNftMint    String?
  
  // Relations
  listingId           String            @unique
  listing             Listing           @relation(fields: [listingId], references: [id])
  buyerId             String
  buyer               User              @relation("BuyerTransactions", fields: [buyerId], references: [id])
  sellerId            String
  seller              User              @relation("SellerTransactions", fields: [sellerId], references: [id])
  dispute             Dispute?
  reviews             Review[]
  uploads             Upload[]

  // Timestamps
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  paidAt              DateTime?
  transferStartedAt   DateTime?
  transferCompletedAt DateTime?
  releasedAt          DateTime?

  @@index([buyerId])
  @@index([sellerId])
  @@index([status])
}

// ============================================
// DISPUTES
// ============================================

model Dispute {
  id                String        @id @default(cuid())
  
  // Reason
  reason            DisputeReason
  description       String        @db.Text
  
  // Evidence
  initiatorEvidence Json?
  respondentEvidence Json?
  
  // Status
  status            DisputeStatus @default(OPEN)
  resolution        DisputeResolution?
  resolutionNotes   String?       @db.Text
  
  // Fees
  disputeFee        Float         // 2% fee charged to losing party
  feeCharged        Boolean       @default(false)
  
  // Buyer Escrow Deposit (for denial claims)
  // When buyer claims they didn't receive, they must deposit additional funds into escrow
  buyerDepositRequired Float?     // 10% of purchase price
  buyerDepositAmount   Float?     @default(0)
  buyerDepositHeld     Boolean    @default(false)
  // If buyer loses dispute, deposit goes to treasury
  depositForfeited     Boolean    @default(false)
  
  // Relations
  transactionId     String        @unique
  transaction       Transaction   @relation(fields: [transactionId], references: [id])
  initiatorId       String
  initiator         User          @relation("DisputeInitiator", fields: [initiatorId], references: [id])
  respondentId      String
  respondent        User          @relation("DisputeRespondent", fields: [respondentId], references: [id])
  
  // Timestamps
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  resolvedAt        DateTime?

  @@index([status])
  @@index([transactionId])
}

// ============================================
// REVIEWS & RATINGS
// ============================================

model Review {
  id            String      @id @default(cuid())
  rating        Int         // 1-5
  comment       String?     @db.Text
  
  // Relations
  transactionId String
  transaction   Transaction @relation(fields: [transactionId], references: [id])
  authorId      String
  author        User        @relation("ReviewAuthor", fields: [authorId], references: [id])
  subjectId     String
  subject       User        @relation("ReviewSubject", fields: [subjectId], references: [id])
  
  // Timestamps
  createdAt     DateTime    @default(now())

  @@unique([transactionId, authorId])
  @@index([subjectId])
}

// ============================================
// WATCHLIST & NOTIFICATIONS
// ============================================

model Watchlist {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  listingId String
  listing   Listing  @relation(fields: [listingId], references: [id])
  createdAt DateTime @default(now())

  @@unique([userId, listingId])
}

model Notification {
  id        String           @id @default(cuid())
  type      NotificationType
  title     String
  message   String
  data      Json?
  read      Boolean          @default(false)
  userId    String
  user      User             @relation(fields: [userId], references: [id])
  createdAt DateTime         @default(now())

  @@index([userId])
  @@index([read])
}

// ============================================
// MESSAGING
// ============================================

model Conversation {
  id            String    @id @default(cuid())

  // Participants
  participant1Id String
  participant1   User      @relation("ConversationParticipant1", fields: [participant1Id], references: [id])
  participant2Id String
  participant2   User      @relation("ConversationParticipant2", fields: [participant2Id], references: [id])

  // Optional: Link to listing (for context)
  listingId     String?

  // Last message preview
  lastMessageAt DateTime?
  lastMessagePreview String?

  // Messages
  messages      Message[]

  // Timestamps
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@unique([participant1Id, participant2Id])
  @@index([participant1Id])
  @@index([participant2Id])
  @@index([lastMessageAt])
}

model Message {
  id             String       @id @default(cuid())
  content        String       @db.Text

  // Sender
  senderId       String
  sender         User         @relation("MessageSender", fields: [senderId], references: [id])

  // Conversation
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  // Status
  read           Boolean      @default(false)
  readAt         DateTime?

  // Timestamps
  createdAt      DateTime     @default(now())

  @@index([conversationId])
  @@index([senderId])
  @@index([read])
}

// ============================================
// TOKEN LAUNCHES
// ============================================

model TokenLaunch {
  id              String            @id @default(cuid())
  
  // Token Info
  tokenName       String
  tokenSymbol     String
  tokenMint       String?
  totalSupply     BigInt
  
  // Launch Config
  launchType      TokenLaunchType
  presalePrice    Float?
  listingPrice    Float?
  
  // Platform Fee (1% of supply)
  platformTokens  BigInt?
  
  // Status
  status          TokenLaunchStatus @default(PENDING)
  
  // Related Project
  projectId       String
  
  // Timestamps
  createdAt       DateTime          @default(now())
  launchedAt      DateTime?

  @@index([status])
}

// ============================================
// ENUMS
// ============================================

enum KycStatus {
  NONE
  PENDING
  VERIFIED
  REJECTED
}

enum Category {
  SAAS
  MOBILE_APP
  WEB_APP
  BROWSER_EXTENSION
  API
  AI_ML
  ECOMMERCE
  MARKETPLACE
  SOCIAL
  PRODUCTIVITY
  DEVELOPER_TOOLS
  FINTECH
  GAMING
  CRYPTO_WEB3
  OTHER
}

enum Blockchain {
  SOLANA
  BASE
  HYPERLIQUID
  ETHEREUM
  BITCOIN
}

enum ListingType {
  AUCTION
  FIXED_PRICE
}

enum ListingStatus {
  DRAFT
  PENDING_REVIEW
  ACTIVE
  ENDED
  SOLD
  CANCELLED
  EXPIRED
}

enum Currency {
  SOL
  USDC
  USD
  APP
}

enum PaymentMethod {
  SOLANA
  STRIPE
  USDC
}

enum TransactionStatus {
  PENDING
  PAID
  IN_ESCROW
  TRANSFER_PENDING
  TRANSFER_IN_PROGRESS
  AWAITING_CONFIRMATION
  DISPUTED
  COMPLETED
  REFUNDED
  CANCELLED
}

enum DisputeReason {
  GITHUB_NOT_TRANSFERRED
  DOMAIN_NOT_TRANSFERRED
  CREDENTIALS_NOT_RECEIVED
  CODE_DOESNT_MATCH
  MISSING_ASSETS
  OTHER
}

enum DisputeStatus {
  OPEN
  AWAITING_RESPONSE
  UNDER_REVIEW
  RESOLVED
  ESCALATED
}

enum DisputeResolution {
  FULL_REFUND
  PARTIAL_REFUND
  RELEASE_TO_SELLER
  EXTEND_DEADLINE
}

enum NotificationType {
  BID_PLACED
  BID_OUTBID
  AUCTION_WON
  AUCTION_LOST
  AUCTION_ENDING_SOON
  TRANSFER_STARTED
  TRANSFER_COMPLETED
  PAYMENT_RECEIVED
  DISPUTE_OPENED
  DISPUTE_RESOLVED
  REVIEW_RECEIVED
  WATCHLIST_ENDING
  MESSAGE_RECEIVED
  BUYER_INFO_REQUIRED      // Notify buyer to submit required info
  BUYER_INFO_REMINDER      // Reminder at 24h and 6h remaining
  BUYER_INFO_SUBMITTED     // Notify seller that buyer submitted info
  BUYER_INFO_DEADLINE      // Notify both when deadline passes
  FALLBACK_TRANSFER_ACTIVE // Notify when fallback process starts
  SYSTEM
}

enum BuyerInfoStatus {
  PENDING          // Buyer hasn't submitted info yet
  PROVIDED         // Buyer has submitted required info
  DEADLINE_PASSED  // 48-hour deadline passed without info
}

enum TokenLaunchType {
  FAIR_LAUNCH
  PRESALE
}

enum TokenLaunchStatus {
  PENDING
  LAUNCHING
  LIVE
  COMPLETED
  FAILED
}

// ============================================
// REFERRAL SYSTEM
// ============================================

model Referral {
  id              String    @id @default(cuid())
  
  // Who referred whom
  referrerId      String
  referrer        User      @relation("Referrer", fields: [referrerId], references: [id])
  
  referredUserId  String    @unique
  referredUser    User      @relation("ReferredUser", fields: [referredUserId], references: [id])
  
  // Tracking
  status          ReferralStatus @default(PENDING)
  
  // Earnings from this referral
  totalEarnings   Float     @default(0)
  
  // Timestamps
  createdAt       DateTime  @default(now())
  convertedAt     DateTime? // When referredUser made first sale/purchase
  
  // Individual earnings records
  earnings        ReferralEarning[]
  
  @@index([referrerId])
  @@index([referredUserId])
}

model ReferralEarning {
  id              String    @id @default(cuid())
  
  referralId      String
  referral        Referral  @relation(fields: [referralId], references: [id])
  
  // What transaction generated this earning
  transactionId   String
  
  // Amounts
  saleAmount      Float     // Total sale amount
  commissionRate  Float     // e.g., 0.02 for 2%
  earnedAmount    Float     // saleAmount * commissionRate
  
  // Status
  status          EarningStatus @default(PENDING)
  paidAt          DateTime?
  
  createdAt       DateTime  @default(now())
  
  @@index([referralId])
  @@index([transactionId])
}

enum ReferralStatus {
  PENDING     // Invited but not signed up
  REGISTERED  // Signed up but no transaction
  ACTIVE      // Has completed at least one transaction
}

enum EarningStatus {
  PENDING     // Waiting for transaction to complete
  AVAILABLE   // Ready to withdraw
  PAID        // Withdrawn/paid out
}

enum OfferStatus {
  ACTIVE
  ACCEPTED
  CANCELLED
  EXPIRED
}

enum UploadType {
  GITHUB
  FILE
  CREDENTIALS
  DOCUMENTATION
  DOMAIN
  DATABASE
  HOSTING
  SOCIAL_ACCOUNT
  API_KEYS
  DESIGN_FILES
}
